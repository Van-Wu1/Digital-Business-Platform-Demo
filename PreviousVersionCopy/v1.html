<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数字化业务决策指挥中心 - 纯净高级版</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --ios-bg: #f2f2f7;
            --ios-card: rgba(255, 255, 255, 0.9);
            --accent-blue: #007aff;
            --deep-blue: #003087;
            --vibrant-orange: #f26d21;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", sans-serif;
            color: #1c1c1e;
        }

        .glass {
            background: var(--ios-card);
            backdrop-filter: saturate(180%) blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        /* 强制固定一页的容器 */
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: 90px 1fr;
            gap: 16px;
            padding: 16px;
            height: 100vh;
            box-sizing: border-box;
        }

        /* 顶部单行聚合条 */
        .top-shelf {
            grid-column: span 12;
            display: flex;
            align-items: center;
            padding: 0 24px;
            border-radius: 20px;
        }

        .stat-group {
            display: flex;
            align-items: center;
            gap: 24px;
            height: 50%;
        }

        .divider {
            width: 1px;
            height: 30px;
            background: rgba(0, 0, 0, 0.1);
            margin: 0 16px;
        }

        /* 主体布局 */
        .map-section {
            grid-column: span 8;
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }

        .sidebar-section {
            grid-column: span 4;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
            /* 关键：允许内容收缩 */
        }

        #map {
            width: 100%;
            height: 100%;
            background: #ffffff;
        }

        /* 地图控制组件 */
        .map-switch-ctrl {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1000;
            display: flex;
            gap: 4px;
            padding: 4px;
            border-radius: 12px;
        }

        .switch-btn {
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 8px;
            color: #8e8e93;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .switch-btn.active {
            background: white;
            color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* 图例 */
        .ios-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            padding: 12px 16px;
            border-radius: 16px;
            width: 220px;
        }

        .legend-gradient {
            height: 4px;
            border-radius: 2px;
            margin: 8px 0;
            background: linear-gradient(to right, var(--deep-blue), #93c5fd, #fff, #fde68a, var(--vibrant-orange));
        }

        /* 紧凑版仪表盘 */
        .mini-gauge {
            position: relative;
            width: 60px;
            height: 60px;
            transform: rotate(-90deg);
        }

        .gauge-bg {
            fill: none;
            stroke: #f2f2f7;
            stroke-width: 8;
        }

        .gauge-path {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #d1d1d6;
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <!-- 顶部单行聚合导航条 -->
        <header class="top-shelf glass">
            <div class="stat-group">
                <div class="flex flex-col">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">省级节点</span>
                    <span class="text-xl font-black text-slate-800">31</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">城市中心</span>
                    <span class="text-xl font-black text-slate-800">342</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">业务区块</span>
                    <span class="text-xl font-black text-slate-800">2,844</span>
                </div>
            </div>

            <div class="divider"></div>

            <div class="flex-1 flex gap-12">
                <div class="flex flex-col">
                    <div class="flex items-center gap-2 mb-0.5">
                        <div class="w-2 h-2 rounded-full bg-blue-600"></div>
                        <span class="text-[9px] font-black text-blue-600 uppercase tracking-widest">年度营收
                            (REVENUE)</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-xl font-black text-slate-800 tracking-tighter">¥128.4</span>
                        <span class="text-[10px] font-bold text-slate-400">万</span>
                    </div>
                </div>
                <div class="flex flex-col">
                    <div class="flex items-center gap-2 mb-0.5">
                        <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                        <span class="text-[9px] font-black text-orange-600 uppercase tracking-widest">销售总额
                            (SALES)</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-xl font-black text-slate-800 tracking-tighter">¥456.2</span>
                        <span class="text-[10px] font-bold text-slate-400">万</span>
                    </div>
                </div>
            </div>

            <div class="px-4 py-2 bg-blue-50 rounded-xl">
                <span class="text-[10px] font-black text-blue-600">实时数据连通中...</span>
            </div>
        </header>

        <!-- 地图主体 -->
        <main class="map-section glass">
            <div class="map-switch-ctrl glass">
                <div id="btn-light" class="switch-btn active" onclick="switchLayer('light')">极简</div>
                <div id="btn-osm" class="switch-btn" onclick="switchLayer('osm')">标准</div>
                <div id="btn-sat" class="switch-btn" onclick="switchLayer('sat')">影像</div>
            </div>
            <div id="map"></div>
            <div class="ios-legend glass">
                <div class="flex justify-between text-[8px] font-black text-slate-400 uppercase tracking-tighter">
                    <span>Low</span>
                    <span>Mid</span>
                    <span>High</span>
                </div>
                <div class="legend-gradient"></div>
                <div class="flex justify-between font-mono text-[9px] text-slate-500 font-bold">
                    <span id="l-min">0</span>
                    <span id="l-max">MAX</span>
                </div>
            </div>
        </main>

        <!-- 右侧看板 -->
        <aside class="sidebar-section">
            <!-- 缩小后的交互信息 -->
            <div class="p-5 glass rounded-[24px]" id="sidebar-info">
                <div class="flex flex-col items-center justify-center h-24 text-slate-300">
                    <p class="text-[10px] font-black uppercase tracking-widest">Select a Node</p>
                </div>
            </div>

            <!-- 排行榜：占据更多剩余空间 -->
            <div class="flex-1 p-6 glass rounded-[24px] flex flex-col min-h-0 overflow-hidden">
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <h3 class="text-[10px] font-black text-slate-800 tracking-widest uppercase">Performance Ranking</h3>
                    <div class="flex gap-1">
                        <div class="w-1 h-1 rounded-full bg-green-500 animate-pulse"></div>
                        <div class="w-1 h-1 rounded-full bg-green-500 animate-pulse delay-75"></div>
                    </div>
                </div>
                <div id="ranking-list" class="flex-1 overflow-y-auto custom-scroll pr-1"></div>
            </div>
        </aside>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const layers = {
            light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
            sat: L.tileLayer('https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', { subdomains: '1234' })
        };

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([35.5, 106], 4);
        layers.light.addTo(map);

        let fullData = { province: null, city: null, district: null };
        let currentLevel = 'province';
        let revenueStats = { min: 0, max: 0, range: 0 };
        let activeGeoLayer = null;
        let backgroundOutlineLayer = null;

        const colorScale = d3.scaleLinear()
            .domain([0, 0.5, 1])
            .range(["#003087", "#f8fafc", "#f26d21"])
            .interpolate(d3.interpolateHcl);

        function switchLayer(type) {
            Object.values(layers).forEach(l => map.removeLayer(l));
            layers[type].addTo(map);
            document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
            if (backgroundOutlineLayer) backgroundOutlineLayer.bringToFront();
            if (activeGeoLayer) activeGeoLayer.bringToFront();
        }

        function updateSidebar(props) {
            const container = document.getElementById('sidebar-info');
            const rev = props.revenue_rmb || 0;
            const sales = props.sales_rmb || 0;
            const revRatio = Math.min(1, rev / 50000000);
            const salesRatio = Math.min(1, sales / 100000000);
            const circum = 2 * Math.PI * 26;

            container.innerHTML = `
                <div class="animate-in fade-in duration-300">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-800 leading-none">${props.name}</span>
                        <span class="text-[9px] font-mono text-slate-400">ID:${props.id || '---'}</span>
                    </div>
                    
                    <div class="flex gap-4 items-center">
                        <div class="flex-1 flex items-center gap-3 p-2 bg-slate-50/80 rounded-xl">
                            <div class="mini-gauge">
                                <svg width="60" height="60"><circle class="gauge-bg" cx="30" cy="30" r="26"></circle>
                                <circle class="gauge-path" cx="30" cy="30" r="26" stroke="var(--deep-blue)" style="stroke-dasharray: ${revRatio * circum} ${circum}"></circle></svg>
                            </div>
                            <div>
                                <p class="text-[8px] font-black text-slate-400 uppercase">Revenue</p>
                                <p class="text-xs font-mono font-black text-blue-800">¥${(rev / 10000).toFixed(0)}w</p>
                            </div>
                        </div>
                        <div class="flex-1 flex items-center gap-3 p-2 bg-slate-50/80 rounded-xl">
                            <div class="mini-gauge">
                                <svg width="60" height="60"><circle class="gauge-bg" cx="30" cy="30" r="26"></circle>
                                <circle class="gauge-path" cx="30" cy="30" r="26" stroke="var(--vibrant-orange)" style="stroke-dasharray: ${salesRatio * circum} ${circum}"></circle></svg>
                            </div>
                            <div>
                                <p class="text-[8px] font-black text-slate-400 uppercase">Sales</p>
                                <p class="text-xs font-mono font-black text-orange-700">¥${(sales / 10000).toFixed(0)}w</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRanking(data) {
            const list = d3.select("#ranking-list");
            list.selectAll("*").remove();
            const sorted = data.features.filter(f => f.properties.revenue_rmb > 0).sort((a, b) => b.properties.revenue_rmb - a.properties.revenue_rmb).slice(0, 20);

            const items = list.selectAll(".item").data(sorted).enter().append("div")
                .attr("class", "flex items-center gap-3 mb-3 group cursor-pointer");

            items.html((d, i) => `
                <div class="w-4 text-[9px] font-black text-slate-200">#${i + 1}</div>
                <div class="flex-1">
                    <div class="flex justify-between mb-1">
                        <span class="text-[10px] font-bold text-slate-700">${d.properties.name}</span>
                        <span class="text-[9px] font-mono font-bold text-slate-400">¥${(d.properties.revenue_rmb / 10000).toFixed(0)}w</span>
                    </div>
                    <div class="h-1 bg-slate-50 rounded-full overflow-hidden">
                        <div class="h-full transition-all duration-700" id="rank-bar-${i}" style="width: 0%; background: ${colorScale((d.properties.revenue_rmb - revenueStats.min) / revenueStats.range)}"></div>
                    </div>
                </div>
            `);
            setTimeout(() => sorted.forEach((d, i) => {
                const el = document.getElementById(`rank-bar-${i}`);
                if (el) el.style.width = (d.properties.revenue_rmb / revenueStats.max * 100) + "%";
            }), 50);
            items.on("mouseenter", (e, d) => updateSidebar(d.properties));
        }

        function renderGeoJson() {
            const data = fullData[currentLevel];
            if (!data) return;

            // 回归清爽背景轮廓
            if (backgroundOutlineLayer) map.removeLayer(backgroundOutlineLayer);
            backgroundOutlineLayer = L.geoJSON(fullData.province, {
                style: { color: '#e5e5ea', weight: 0.8, fillOpacity: 0, interactive: false }
            }).addTo(map);

            const vals = data.features.map(f => f.properties.revenue_rmb).filter(v => v > 0);
            revenueStats.min = Math.min(...vals);
            revenueStats.max = Math.max(...vals);
            revenueStats.range = revenueStats.max - revenueStats.min;
            document.getElementById('l-max').innerText = (revenueStats.max / 10000).toFixed(0) + 'W';
            document.getElementById('l-min').innerText = (revenueStats.min / 10000).toFixed(0) + 'W';

            if (activeGeoLayer) map.removeLayer(activeGeoLayer);
            activeGeoLayer = L.geoJSON(data, {
                style: (f) => ({
                    fillColor: colorScale((f.properties.revenue_rmb - revenueStats.min) / revenueStats.range),
                    weight: 1, color: '#ffffff', fillOpacity: 0.8
                }),
                onEachFeature: (f, l) => {
                    l.on({
                        mouseover: (e) => {
                            e.target.setStyle({ weight: 3, color: '#007aff' });
                            e.target.bringToFront();
                            updateSidebar(f.properties);
                        },
                        mouseout: (e) => activeGeoLayer.resetStyle(e.target),
                        click: (e) => map.flyToBounds(e.target.getBounds(), { padding: [40, 40] })
                    });
                }
            }).addTo(map);

            renderRanking(data);
        }

        async function init() {
            try {
                const [p, c, d] = await Promise.all([
                    fetch('./shp/province_summary.geojson'),
                    fetch('./shp/city_summary.geojson'),
                    fetch('./shp/district_summary.geojson')
                ]);
                fullData.province = await p.json();
                fullData.city = await c.json();
                fullData.district = await d.json();
                renderGeoJson();

                map.on('zoomend', () => {
                    const z = map.getZoom();
                    let next = z > 8 ? 'district' : (z > 5 ? 'city' : 'province');
                    if (next !== currentLevel) {
                        currentLevel = next;
                        renderGeoJson();
                    }
                });
            } catch (err) { console.error(err); }
        }

        window.onload = () => { map.invalidateSize(); init(); };
    </script>
</body>

</html>